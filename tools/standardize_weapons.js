import fs from 'fs';
import path from 'path';

const dbPath = 'r:/AI/nikke-build-search/public/data/nikke_db.json';
const db = JSON.parse(fs.readFileSync(dbPath, 'utf8'));

// 특정 니케 전용 무기 이름 맵 (자동 추출이 어렵거나 잘못된 경우)
const manualWeaponNames = {
    "16": "세븐스 드워프 제로",      // 라피 : 레드 후드
    "470": "울프즈 베인",           // 레드 후드
    "1": "밀리터리아",              // 라피
    "2": "올 브레이크",             // 네온
    "3": "리버틴 테일",             // 아니스
    "82": "드릴 펀치",              // 리타
    "83": "마이티 봄버",            // 센티
    "100": "히어로 신드롬",         // 라플라스
    "101": "사디스틱 카니발",       // 드레이크
    "102": "메이플라이",            // N102
    "121": "메이플라이",            // 앤 : 미라클 페어리
    "200": "쇼퍼홀릭",              // 루피
    "210": "언락 유토피아",         // 엑시아
    "220": "세븐스 드워프",         // 스노우 화이트
    "224": "세븐스 드워프",         // 스노우 화이트 : 이노센트 데이즈
    "230": "화무십일홍",            // 홍련
    "233": "화무십일홍",            // 홍련 : 흑영
    "270": "화이트 폴룩스",         // 블랑
    "271": "블랙 카스토르",         // 누아르
    "310": "더 클래식",             // 에이드
    "312": "브라이트 클리너",       // 소다
    "400": "뉴 에이지",             // 모더니아
    "410": "언그레이트풀 오즈",     // 도로시
    "514": "라이터즈 이레이저",     // 그레이브 (기존 '스포일러'에서 수정)
    "515": "유리구두",              // 신데렐라
    "800": "제노사이드",            // 크로우 (예시)
    "70": "퍼펙트 라인",            // 브리드
    "71": "크림슨 크루세이더",      // 솔린
    "72": "원더링 트랙",            // 디젤
    "20": "리맴버",                 // 델타
    "22": "드라마틱",               // 시그널
    "40": "포비든 기프트",          // 유니
    "41": "페인풀 월드",            // 미하라
    "221": "홀리 그레이스",         // 라푼젤
    "225": "홀리 그레이스",         // 라푼젤 : 퓨어 블라썸
    "240": "어너러블",              // 헬름
    "243": "배틀쉽",                // 헬름 : 아쿠아마린
    "350": "페로셔스",              // 마스트
    "351": "큐리어스",              // 앵커
    "131": "비타민 밤",             // 페퍼
    "132": "썸머 샷",               // 메어리 (이격)
    "150": "클래시컬 아디지오",     // 율리아
    "381": "해피 퍼피",             // 비스킷
    "382": "라이언 로어",           // 레오나
    "282": "이치겐킨",              // 사쿠라
    "281": "드래곤 헤드",           // 목단
    "61": "버디 버디 익스플로젼",   // 미카
    "60": "딜리셔스 블래스트",      // 벨로타
    "392": "스틸 베이비",           // 라이
    "500": "붐 건",                 // 일레그
    "501": "트랜지스터",            // 트로니
    "32": "인플렉서블",             // 미란다
    "33": "클라우드 아이",          // 키리
    "92": "퍼펙셔니스트",           // 은화
    "91": "퓨어몬스터",             // 베스티
    "11": "스페셜 테라피스트",      // 엠마
    "291": "새크리파이스 카니발",   // 에테르
    "321": "이성의 눈",             // 마르차나
    "330": "유어 마제스티",         // 크라운
    "331": "은둔자",                // 차임 (킬로로 나옴?)
    "361": "은둔자",                // 킬로
    "412": "미드나잇 시프",         // 팬텀
    "513": "내추럴 가든",           // 플로라
    "810": "백의 약정",             // 2B
    "811": "백의 긍지",             // A2
    "43": "히든 엣지",              // D : 킬러 와이프
    "380": "야옹 야옹",             // 네로
    "193": "큰곰자리의 겨울",       // 네베
    "212": "식스 센스",             // 노벨
    "430": "메이크 썸 노이즈",      // 노이즈
    "202": "리스크 테이커",         // 도라
    "280": "골든 토미",             // 로산나
    "283": "골든 토미",             // 로산나 : 시크 오션
    "203": "쇼퍼홀릭",              // 루피 : 윈터 쇼퍼
    "290": "솜누스",                // 마나
    "62": "겨울의 축포",            // 미카 : 스노우 버디
    "303": "MIMG-07",               // 프로덕트 12
    "431": "볼륨 맥스",             // 볼륨
    "401": "헤비토커",              // 신
    "432": "헤븐스워드 아리아",     // 아리아
    "201": "모노폴리",              // 얀
    "111": "T.O.P",                 // 자칼
    "311": "코코렐라",              // 코코아
    "192": "에너제틱 서바이버",     // 토브
    "300": "헌팅 이글",             // 솔져 이글 (E.G.)
    "301": "클러치 팔콘",           // 솔져 팔쿤 (F.A.)
    "306": "서치 아울",             // 솔져 오울 (O.W.)
    "302": "MISR-03",               // 프로덕트 08
    "305": "MISG-09",               // 프로덕트 23
    "821": "클러스터 아이스",       // 에밀리아
    "820": "데몬즈 가드",           // 렘
    "822": "데몬즈 브레스",         // 람
    "801": "파워",                  // 파워
    "800": "언노운",                // 마키마
    "802": "고스트",                // 히메노
    "812": "파스칼",                // 파스칼
    "550": "빅토리 팡파레",         // 베이
    "551": "유 캔 두잇",            // 클레이
    "411": "내추럴 가든",           // 플로라
    "308": "샤이닝 썬",             // iDoll 썬
    "304": "댄싱 플라워",           // iDoll 플라워
    "307": "MISG-09",               // 프로덕트 23
    "23": "리맴버",                 // 델타 : 닌자 시프
    "75": "원더링 트랙",            // 디젤 : 윈터 스위츠
    "354": "페로셔스",              // 마스트 : 로망틱 메이드
    "284": "이치겐킨",              // 사쿠라 : 블룸 인 서머
    "314": "브라이트 클리너",       // 소다 : 트윙클링 바니
    "74": "크림슨 크루세이더",      // 솔린 : 프로스트 티켓
    "355": "큐리어스",              // 앵커 : 이노센트 메이드
    "315": "더 클래식",             // 에이드 : 에이전트 바니
    "502": "붐 건",                 // 일레그 : 붐 앤 쇼크
    "94": "퓨어몬스터",             // 베스티 : 택티컬 업
    "95": "퍼펙셔니스트",           // 은화 : 택티컬 업
    "836": "이치겐킨",              // 사쿠라 : 스즈하라
    "42": "플리즈 잭팟",            // 루쥬
    "320": "엘레강트 녹턴",         // 나가
    "322": "체이스 네일",           // 티아
};

// 무기 종류 이름 (제외용)
const genericWeaponTypes = [
    "소총 (AR)", "저격소총 (SR)", "샷건 (SG)", "기관단총 (SMG)", "런처 (RL)", "기관총 (MG)",
    "소총", "저격소총", "샷건", "기관단총", "런처", "기관총",
    "일반 공격", "일반공격", "기본 공격", "기본공격"
];

let updatedCount = 0;

db.nikkes.forEach(nikke => {
    let finalWeaponName = "";

    // 1. 수동 지정 맵 확인
    if (manualWeaponNames[nikke.id]) {
        finalWeaponName = manualWeaponNames[nikke.id];
    } else {
        // 2. 기존 필드에서 추출 시도
        const candidates = [
            nikke.weapon_name,
            nikke.weapon_info?.weapon_name,
            nikke.skills_detail?.normal?.name,
            nikke.weapon_info?.name
        ];

        for (const cand of candidates) {
            if (cand && typeof cand === 'string' && cand.trim() !== "" && !genericWeaponTypes.includes(cand.trim())) {
                finalWeaponName = cand.trim();
                break;
            }
        }
    }

    // 3. 여전히 없으면 스킬 이름에서 유추 (보통 버스트 스킬 이름에 무기명이 들어가는 경우가 많음)
    if (!finalWeaponName && nikke.skills_detail?.burst?.name) {
        const burstName = nikke.skills_detail.burst.name;
        // 버스트 이름이 너무 길지 않으면 후보로 고려 (단, 고유명사일 가능성이 높은 경우만)
        if (burstName.length < 15 && !burstName.includes(" ")) {
            // finalWeaponName = burstName; // 위험할 수 있으므로 주석 처리
        }
    }

    // 최종 업데이트
    if (finalWeaponName) {
        if (nikke.weapon_name !== finalWeaponName) {
            nikke.weapon_name = finalWeaponName;
            updatedCount++;
        }
        
        // normal 스킬 이름도 동기화
        if (nikke.skills_detail && nikke.skills_detail.normal) {
            nikke.skills_detail.normal.name = finalWeaponName;
        }
    } else {
        // 정말 없는 경우 빈칸으로 두어 UI에서 폴백되게 하거나, 최소한 "일반 공격" 같은 건 제거
        if (genericWeaponTypes.includes(nikke.weapon_name)) {
            nikke.weapon_name = "";
            updatedCount++;
        }
    }

    // 불필요한 필드 정리
    if (nikke.weapon_info) {
        delete nikke.weapon_info;
    }
});

fs.writeFileSync(dbPath, JSON.stringify(db, null, 2), 'utf8');
console.log(`Standardized weapon names. Updated ${updatedCount} Nikkes.`);
